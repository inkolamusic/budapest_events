<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Budapest Events Database</title>
<style>
  body { font-family: Arial, sans-serif; margin: 10px; background: #f7f7f7; }
  h1 { text-align: center; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
  th { background-color: #4CAF50; color: white; }
  tr:nth-child(even) { background-color: #f2f2f2; }
  tr:hover { background-color: #ddd; cursor: pointer; }
  .filter-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 10px 0; }
  select { padding: 5px; }
  a { color: #0073e6; text-decoration: underline; }
  a:hover { text-decoration: none; }
  .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto;
           background-color: rgba(0,0,0,0.5); }
  .modal-content { background-color: #fff; margin: 5% auto; padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; }
  .close { float: right; font-size: 24px; font-weight: bold; cursor: pointer; }
  @media (max-width: 600px) {
    th, td { font-size: 12px; padding: 6px; }
    .modal-content { width: 95%; }
  }
</style>
</head>
<body>

<h1>Budapest & Szentendre Events 2026</h1>

<div class="filter-container">
  <select id="filterCity">
    <option value="">All Cities</option>
  </select>
  <select id="filterSeason">
    <option value="">All Seasons</option>
  </select>
  <select id="filterMonth">
    <option value="">All Months</option>
  </select>
  <select id="filterCategory">
    <option value="">All Categories</option>
  </select>
</div>

<table id="eventsTable">
  <thead>
    <tr>
      <th>Event name</th>
      <th>City</th>
      <th>Season</th>
      <th>Month</th>
      <th>Category</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="eventModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <div id="modalBody"></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRT2Ir3fvsGHchJyk04LpS7qBTPuGoiytSy37BFK-RVoo8WNCPIyPMYTH_OLnkRZH6LegqjWF-MFm4I/pub?gid=0&single=true&output=csv";

// Загружаем данные из CSV
async function loadData() {
  try {
    const res = await fetch(sheetURL);
    const text = await res.text();
    const data = Papa.parse(text, { header: true }).data.filter(row => row["Event name"]);
    populateFilters(data);
    displayTable(data);
    setupFiltering(data);
  } catch (e) {
    console.error("Ошибка загрузки данных:", e);
  }
}

// Создание фильтров
function populateFilters(data) {
  const cities = [...new Set(data.map(d => d.City?.trim()).filter(Boolean))];
  const seasons = [...new Set(data.map(d => d.Season?.trim()).filter(Boolean))];
  const months = [...new Set(data.map(d => d.Month?.trim()).filter(Boolean))];

  const categorySet = new Set();
  data.forEach(d => {
    if (d.Category) {
      d.Category.split(",").forEach(cat => {
        const clean = cat.trim().toLowerCase();
        if (clean) categorySet.add(clean);
      });
    }
  });
  const categories = Array.from(categorySet).sort();

  fillSelect("filterCity", cities);
  fillSelect("filterSeason", seasons);
  fillSelect("filterMonth", months);
  fillSelect("filterCategory", categories);
}

// Заполняем select
function fillSelect(id, values) {
  const select = document.getElementById(id);
  values.forEach(v => {
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v.charAt(0).toUpperCase() + v.slice(1);
    select.appendChild(opt);
  });
}

// Настройка фильтров
function setupFiltering(data) {
  const selects = document.querySelectorAll("select");
  selects.forEach(s => s.addEventListener("change", () => {
    const filters = {
      City: document.getElementById("filterCity").value,
      Season: document.getElementById("filterSeason").value,
      Month: document.getElementById("filterMonth").value,
      Category: document.getElementById("filterCategory").value
    };
    const filtered = data.filter(d =>
      (!filters.City || d.City?.trim() === filters.City) &&
      (!filters.Season || d.Season?.trim() === filters.Season) &&
      (!filters.Month || d.Month?.trim() === filters.Month) &&
      (!filters.Category || (
        d.Category &&
        d.Category.split(",").map(c => c.trim().toLowerCase()).includes(filters.Category)
      ))
    );
    displayTable(filtered);
  }));
}

// Форматируем Food and Drink как список с активными ссылками
function formatFoodAndDrink(text) {
  if (!text) return "—";
  const items = text.split(/\n|,/).map(i => i.trim()).filter(Boolean);
  return items.map(item => {
    const urlMatch = item.match(/https?:\/\/[^\s]+/);
    if (urlMatch) {
      const url = urlMatch[0];
      const name = item.replace(url, "").trim() || url;
      return `<div><a href="${url}" target="_blank">${name}</a></div>`;
    }
    return `<div>${item}</div>`;
  }).join("");
}

// Форматируем Location как список с активными ссылками
function formatLocation(text) {
  if (!text) return "—";
  const items = text.split(/\n|,/).map(i => i.trim()).filter(Boolean);
  return items.map(item => {
    const urlMatch = item.match(/https?:\/\/[^\s]+/);
    if (urlMatch) {
      const url = urlMatch[0];
      const name = item.replace(url, "").trim() || url;
      return `<div><a href="${url}" target="_blank">${name}</a></div>`;
    }
    return `<div>${item}</div>`;
  }).join("");
}

// Отображение таблицы
function displayTable(data) {
  const tbody = document.querySelector("#eventsTable tbody");
  tbody.innerHTML = "";
  data.forEach(row => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="event-link" style="color:#0073e6;text-decoration:underline;">${row["Event name"]}</td>
      <td>${row.City || ""}</td>
      <td>${row.Season || ""}</td>
      <td>${row.Month || ""}</td>
      <td>${row.Category || ""}</td>
    `;
    tr.addEventListener("click", () => showModal(row));
    tbody.appendChild(tr);
  });
}

// Модальное окно с полной информацией
function showModal(row) {
  const modal = document.getElementById("eventModal");
  const body = document.getElementById("modalBody");
  body.innerHTML = `
    <h2>${row["Event name"]}</h2>
    <p><b>City:</b> ${row.City || ""}</p>
    <p><b>Location:</b><br>${formatLocation(row.Location)}</p>
    <p><b>Season:</b> ${row.Season || ""}</p>
    <p><b>Month:</b> ${row.Month || ""}</p>
    <p><b>Start Date:</b> ${row["Start Date"] || ""}</p>
    <p><b>End Date:</b> ${row["End Date"] || ""}</p>
    <p><b>Annual:</b> ${row.Annual || ""}</p>
    <p><b>Category:</b> ${row.Category || ""}</p>
    <p><b>Description:</b> ${row.Description || ""}</p>
    <p><b>Food and Drink:</b><br>${formatFoodAndDrink(row["Food and Drink"])}</p>
    <p><b>Information:</b> <a href="${row.Information}" target="_blank">${row.Information}</a></p>
  `;
  modal.style.display = "block";
}

// Закрытие модального окна
document.querySelector(".close").onclick = () => document.getElementById("eventModal").style.display = "none";
window.onclick = (e) => {
  const modal = document.getElementById("eventModal");
  if (e.target === modal) modal.style.display = "none";
};

// Загружаем данные при открытии страницы
loadData();
</script>

</body>
</html>
